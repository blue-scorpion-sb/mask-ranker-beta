<!DOCTYPE html> 

<html lang="zh-HK"> 

<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Mask Ranker beta âœ¨</title> 
    <script src="https://cdn.tailwindcss.com"></script> 
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script> 
	
    <style> 

        body { font-size: 1.15rem; }  
        .quadrant-bg { background-size: 25px 25px; background-image: radial-gradient(circle, #fbcfe8 1.5px, transparent 1.5px); } 
         
        /* å››è§’è±¡é™æ¨™ç±¤ */ 
        .outer-label { font-size: 14px; font-weight: 900; position: absolute; white-space: nowrap; z-index: 5; pointer-events: none; }        

        /* åæ¨™è»¸æ¨™é¡Œæ¨£å¼ (çµ±ä¸€åƒ¹éŒ¢åŒè©•åˆ†) */ 
        .axis-title {  
            font-size: 0.85rem;  
            font-weight: 900;  
            color: #94a3b8;  
            text-transform: uppercase;  
            letter-spacing: 0.15em;  
            position: absolute;  
            white-space: nowrap; 
            z-index: 5; 
        }  

        /* åæ¨™è»¸å®¹å™¨ */ 
        .chart-container { z-index: 10; position: relative; overflow: visible !important; } 
        #gridLayer { overflow: visible !important; }  

        /* åå­—åˆ†ç•Œç·šèˆ‡ç®­é ­ */ 
        #yLine::after { 
            content: ''; 
            position: absolute; 
            top: -12px; 
            left: 50%; 
            transform: translateX(-50%); 
            border-left: 7px solid transparent; 
            border-right: 7px solid transparent; 
            border-bottom: 14px solid rgba(244, 114, 182, 0.8); 
        } 
        #xLine::after { 
            content: ''; 
            position: absolute; 
            right: -12px; 
            top: 50%; 
            transform: translateY(-50%); 
            border-top: 7px solid transparent; 
            border-bottom: 7px solid transparent; 
            border-left: 14px solid rgba(244, 114, 182, 0.8); 
        }  

        /* Tooltip æ¨£å¼ */ 
        .mask-node { transition: all 0.2s ease; z-index: 20; cursor: pointer; -webkit-tap-highlight-color: transparent; } 
        .mask-node.active-node { z-index: 999 !important; } 
        .tooltip {  
            position: absolute; bottom: 135%; width: 85vw; max-width: 300px; background: rgba(15, 23, 42, 0.98);  
            backdrop-filter: blur(15px); color: white; padding: 1.5rem; border-radius: 1.5rem;  
            opacity: 0; visibility: hidden; transition: all 0.2s ease; pointer-events: none; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); border: 1px solid rgba(255,255,255,0.15); 
        } 
        .tooltip-down { bottom: auto; top: 135%; } 
        .active-node .tooltip { opacity: 1; visibility: visible; pointer-events: auto; } 
        .btn-action { pointer-events: auto; cursor: pointer; padding: 10px; font-size: 1.4rem; } 

    </style> 

</head> 

<body class="bg-pink-50/30 min-h-screen pb-20 font-sans text-slate-800 overflow-x-hidden" onclick="closeAllTooltips()"> 

    <div class="max-w-7xl mx-auto p-4 md:p-6 pt-6"> 
        <header class="flex justify-between items-center mb-8 border-b-2 border-pink-200 pb-4"> 
            <div class="flex items-center gap-4"> 
                <button onclick="event.stopPropagation(); toggleSettings()" class="bg-white p-3 rounded-xl shadow-sm border border-pink-100 text-2xl">âš™ï¸</button> 
                <h1 class="text-3xl font-black text-pink-600 tracking-tighter italic">Mask Ranker <span class="text-sm font-bold text-slate-400 not-italic">beta</span></h1> 
            </div> 
            <div id="displayUserName" class="text-xs bg-white px-4 py-2 rounded-full border border-pink-200 font-bold text-pink-500">ğŸ‘¤ è¼‰å…¥ä¸­...</div> 
        </header>  

        <div id="settingsPanel" class="hidden bg-indigo-950 text-white p-6 rounded-[2.5rem] mb-8 shadow-2xl border-4 border-indigo-400" onclick="event.stopPropagation()"> 
            <div class="grid grid-cols-2 gap-6"> 
                <div class="space-y-3"> 
                    <p class="text-pink-400 text-xs font-bold uppercase">ğŸ’° åƒ¹éŒ¢ä¸Šé™ / åˆ†ç•Œ</p> 
                    <input type="number" id="limitPrice" class="w-full bg-white/10 rounded-xl p-3 text-lg outline-none" value="10" oninput="renderCurrentData()"> 
                    <input type="number" id="splitPrice" class="w-full bg-white/10 rounded-xl p-3 text-lg outline-none" value="5" oninput="renderCurrentData()"> 
                </div> 
                <div class="space-y-3"> 
                    <p class="text-pink-400 text-xs font-bold uppercase">â­ è©•åˆ†ä¸Šé™ / åˆ†ç•Œ</p> 
                    <input type="number" id="limitRating" class="w-full bg-white/10 rounded-xl p-3 text-lg outline-none" value="10" oninput="renderCurrentData()"> 
                    <input type="number" id="splitRating" class="w-full bg-white/10 rounded-xl p-3 text-lg outline-none" value="5" oninput="renderCurrentData()"> 
                </div> 
            </div> 
        </div> 

        <div class="flex flex-col lg:flex-row gap-12"> 
            <div class="lg:w-1/3 order-2 lg:order-1" onclick="event.stopPropagation()"> 
                <div id="inputCard" class="bg-white p-8 rounded-[2.5rem] shadow-xl border-2 border-pink-100"> 
                    <h2 id="formTitle" class="text-2xl font-black mb-6 text-indigo-950 italic">ğŸš€ è©•æ¸¬é¢è†œ</h2> 
                    <div class="space-y-4"> 
                        <input type="text" id="mName" class="w-full bg-slate-50 rounded-2xl p-4 outline-none border-2 border-transparent focus:border-pink-200" placeholder="ğŸ·ï¸ é¢è†œå…¨å"> 
                        <div class="grid grid-cols-2 gap-4"> 
                            <input type="number" id="mPrice" class="w-full bg-slate-50 rounded-2xl p-4 outline-none border-2 border-transparent focus:border-pink-200" placeholder="ğŸ’° å–®ç‰‡åƒ¹éŒ¢"> 
                            <input type="number" id="mRating" class="w-full bg-slate-50 rounded-2xl p-4 outline-none border-2 border-transparent focus:border-pink-200" placeholder="â­ è©•åˆ† 1-10"> 
                        </div> 
                        <input type="text" id="mSource" class="w-full bg-slate-50 rounded-2xl p-4 outline-none border-2 border-transparent focus:border-pink-200" placeholder="ğŸ“ è³¼å…¥åœ°é» (ä¾‹å¦‚: è¬å¯§)"> 
                        <textarea id="mComment" maxlength="20" rows="1" class="w-full bg-slate-50 rounded-2xl p-4 outline-none border-2 border-transparent focus:border-pink-200" placeholder="ğŸ’¬ ç°¡çŸ­è©•èª (20å­—å…§)"></textarea> 
                        <input type="file" id="mImg" accept="image/*" class="text-sm w-full"> 
                        <div class="flex gap-3 pt-2"> 
                            <button onclick="saveData()" id="saveBtn" class="flex-1 bg-indigo-950 text-white font-black py-5 rounded-2xl shadow-lg text-xl active:scale-95 transition-all">ç™¼å¸ƒè©•æ¸¬ â˜ï¸</button> 
                            <button onclick="cancelEdit()" id="cancelBtn" class="hidden px-6 bg-slate-100 rounded-2xl font-bold text-slate-400">X</button> 
                        </div> 
                    </div> 
                </div> 
            </div> 
 
            <div class="lg:w-2/3 order-1 lg:order-2"> 
                <div class="relative px-12 pt-12 pb-16"> 
                    <div class="outer-label -top-1 left-12 text-red-500">ğŸ’¸ æµªè²»é‡‘éŒ¢</div> 
                    <div class="outer-label -top-1 right-12 text-emerald-600">ğŸ’ è²´å©¦é¦–é¸</div> 
                    <div class="outer-label -bottom-1 left-12 text-slate-400">ğŸ’¤ å¹³åƒ¹ç²—ç”¨</div> 
                    <div class="outer-label -bottom-1 right-12 text-blue-600">ğŸ”¥ æ€§åƒ¹æ¯”ç‹</div>  

                    <div class="axis-title" style="top: 50%; left: -10px; transform: translateY(-50%) rotate(-90deg);">ğŸ’° Price / åƒ¹éŒ¢</div>  

                    <div class="chart-container relative bg-white rounded-[3rem] shadow-2xl border-8 border-white aspect-square ring-4 ring-pink-100/50"> 
                        <div id="gridLayer" class="absolute inset-0 rounded-[2.5rem] quadrant-bg"> 
                            <div id="yLine" class="absolute h-full w-[2.2px] bg-pink-400/40"></div> 
                            <div id="xLine" class="absolute w-full h-[2.2px] bg-pink-400/40"></div> 
                        </div> 
                        <div id="chartArea" class="absolute inset-0 z-30 p-6"></div> 
                    </div>  

                    <div class="axis-title w-full text-center" style="bottom: 8px; left: 0;">â­ Rating / è©•åˆ†</div> 
                </div> 
            </div> 
			
        </div> 

    </div> 

 
    <script> 

        // --- è«‹æ›´æ›ç‚ºä½ çš„æ­£ç¢ºæ†‘è­‰ --- 
        const SB_URL = 'https://ayulzvrljioqcfoqrsev.supabase.co ';  
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dWx6dnJsamlvcWNmb3Fyc2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzk3MzUsImV4cCI6MjA4NDk1NTczNX0.3iCIGRfR42cg12qoE5IUHb0EFn1yq9dDqAW-jcFmQDo '; 
		
        let client, myName = localStorage.getItem('mask_username'), cachedData = [], editingId = null; 

        async function initApp() { 
            if (typeof supabase === 'undefined' || SB_URL.includes('YOUR_')) return; 
            client = window.supabase.createClient(SB_URL, SB_KEY); 
            if (!myName) { 
                myName = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š") || "åŒ¿åå¤§å¸«"; 
                localStorage.setItem('mask_username', myName); 
            } 
            document.getElementById('displayUserName').innerText = "ğŸ‘¤ " + myName; 
            await loadData(); 
            setInterval(loadData, 15000); 
        }  

        async function loadData() { 
            const { data, error } = await client.from('masks').select('*').order('created_at', { ascending: false }); 
            if (!error) { cachedData = data; renderCurrentData(); } 
        }  

        function closeAllTooltips() { 
            document.querySelectorAll('.mask-node').forEach(n => n.classList.remove('active-node')); 
        }  

        function toggleTooltip(event) { 
            event.stopPropagation(); 
            const node = event.currentTarget; 
            const isActive = node.classList.contains('active-node'); 
            closeAllTooltips(); 
            if (!isActive) node.classList.add('active-node'); 
        }  

        function renderCurrentData() { 
            const area = document.getElementById('chartArea'); 
            area.innerHTML = ''; 
            const limitP = parseFloat(document.getElementById('limitPrice').value) || 10; 
            const limitR = parseFloat(document.getElementById('limitRating').value) || 10; 
            const splitP = parseFloat(document.getElementById('splitPrice').value) || 5; 
            const splitR = parseFloat(document.getElementById('splitRating').value) || 5;  
            const xPct = ((splitR - 1) / (limitR - 1)) * 100; 
            const yPct = (1 - (splitP / limitP)) * 100;  

            document.getElementById('yLine').style.left = `${xPct}%`; 
            document.getElementById('xLine').style.top = `${yPct}%`;  

            cachedData.forEach(m => { 
                const x = ((m.rating - 1) / (limitR - 1)) * 100; 
                const y = (1 - (m.price / limitP)) * 100;               
                const node = document.createElement('div'); 
                node.className = "mask-node absolute w-14 h-14 -ml-7 -mt-7"; 
                node.style.left = `${Math.max(5, Math.min(x, 95))}%`; 
                node.style.top = `${Math.max(5, Math.min(y, 95))}%`; 
                node.onclick = toggleTooltip;  

                let ttStyle = "left: 50%; transform: translateX(-50%);"; 
                if (x > 70) ttStyle = "right: -10px; left: auto; transform: translateX(0);"; 
                if (x < 30) ttStyle = "left: -10px; transform: translateX(0);"; 
                const vClass = y < 25 ? "tooltip-down" : "";  

                node.innerHTML = ` 
                    <div class="w-full h-full rounded-2xl border-[3px] shadow-lg overflow-hidden bg-white ${m.user_name === myName ? 'border-pink-500 ring-4 ring-pink-100' : 'border-indigo-400'}"> 
                        ${m.img_url ? `<img src="${m.img_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center font-black text-slate-200 text-2xl uppercase">${m.name.substring(0,1)}</div>`} 
                    </div> 

                    <div class="tooltip ${vClass}" style="${ttStyle}" onclick="event.stopPropagation()"> 
                        <div class="flex justify-between items-start mb-4"> 
                            <p class="font-black text-pink-400 text-xl flex-1 pr-4">${m.name}</p> 
                            <div class="flex gap-2 shrink-0"> 
                                <button onclick="startEdit(${m.id}, '${m.name.replace(/'/g, "\\'")}', ${m.price}, ${m.rating}, '${(m.source || '').replace(/'/g, "\\'")}', '${(m.comment || '').replace(/'/g, "\\'")}')" class="btn-action">âœï¸</button>
                                <button onclick="deleteItem(${m.id}, '${m.name.replace(/'/g, "\\'")}')" class="btn-action">ğŸ—‘ï¸</button> 
                            </div> 
                        </div> 

                        <div class="grid grid-cols-3 gap-2 text-center mb-4 border-b border-white/10 pb-3"> 
                            <div><p class="text-[10px] text-white/40 uppercase font-bold">Price</p><p class="font-bold text-sm">$${m.price}</p></div> 
                            <div><p class="text-[10px] text-white/40 uppercase font-bold">Rating</p><p class="font-bold text-sm">${m.rating}/10</p></div> 
                            <div class="truncate"><p class="text-[10px] text-white/40 uppercase font-bold">Shop</p><p class="font-bold text-sm truncate">${m.source || '-'}</p></div> 
                        </div> 

                        <div class="bg-white/5 p-3 rounded-xl italic text-sm text-slate-100 break-words">"${m.comment || 'å†‡è©•èª'}"</div> 
                        <p class="text-[10px] text-white/20 mt-4 text-right">By ${m.user_name}</p> 

                    </div> 

                `; 
                area.appendChild(node); 
            }); 
        } 

        async function saveData() { 
            const name = document.getElementById('mName').value; 
            const price = parseFloat(document.getElementById('mPrice').value); 
            const rating = parseFloat(document.getElementById('mRating').value); 
            const source = document.getElementById('mSource').value; 
            const comment = document.getElementById('mComment').value; 
            const imgFile = document.getElementById('mImg').files[0];  

            if (!name || isNaN(price) || isNaN(rating)) return alert("å¡«å¥½å¿…å¡«é …å…ˆï¼ğŸ’…"); 
            const btn = document.getElementById('saveBtn'); btn.disabled = true;  

            try { 
                let finalImgUrl = ""; 
                if (imgFile) { 
                    const blob = await compressImage(imgFile); 
                    const fileName = `${Date.now()}.jpg`; 
                    const { error: upErr } = await client.storage.from('mask-images').upload(fileName, blob); 
                    if (upErr) throw upErr; 
                    finalImgUrl = client.storage.from('mask-images').getPublicUrl(fileName).data.publicUrl; 
                }  

                const payload = { name, price, rating, source, comment, user_name: myName }; 
                if (finalImgUrl) payload.img_url = finalImgUrl;  
                if (editingId) await client.from('masks').update(payload).eq('id', editingId); 
                else await client.from('masks').insert([payload]);  

                cancelEdit(); await loadData(); 
            } catch (err) { alert("å¤±æ•—: " + err.message); } finally { btn.disabled = false; } 
        } 

        function compressImage(file) { 
            return new Promise(resolve => { 
                const reader = new FileReader(); reader.readAsDataURL(file); 
                reader.onload = (e) => { 
                    const img = new Image(); img.src = e.target.result; 
                    img.onload = () => { 
                        const canvas = document.createElement('canvas'); 
                        const MAX = 800; let w = img.width, h = img.height; 
                        if (w > MAX) { h *= MAX/w; w = MAX; } 
                        canvas.width = w; canvas.height = h; 
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h); 
                        canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.7); 
                    }; 
                }; 
            }); 
        } 

        async function deleteItem(id, name) { 
            event.stopPropagation(); 
            if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) { await client.from('masks').delete().eq('id', id); await loadData(); } 
        } 

        function startEdit(id, name, price, rating, source, comment) { 
            event.stopPropagation(); editingId = id; 
            document.getElementById('mName').value = name; document.getElementById('mPrice').value = price; 
            document.getElementById('mRating').value = rating; document.getElementById('mSource').value = source || ''; 
            document.getElementById('mComment').value = comment || ''; 
            document.getElementById('formTitle').innerText = "âœï¸ ç·¨è¼¯è©•æ¸¬"; document.getElementById('saveBtn').innerText = "æ›´æ–°è³‡æ–™ ğŸ’¾"; 
            document.getElementById('cancelBtn').classList.remove('hidden'); 
            window.scrollTo({ top: document.getElementById('inputCard').offsetTop - 20, behavior: 'smooth' }); 
        }  

        function cancelEdit() { 
            editingId = null; ["mName", "mPrice", "mRating", "mSource", "mComment", "mImg"].forEach(id => document.getElementById(id).value = ''); 
            document.getElementById('formTitle').innerText = "ğŸš€ è©•æ¸¬é¢è†œ"; document.getElementById('saveBtn').innerText = "ç™¼å¸ƒè©•æ¸¬ â˜ï¸"; 
            document.getElementById('cancelBtn').classList.add('hidden'); 
        }  

        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); } 
        initApp(); 

    </script> 

</body> 

</html> 
