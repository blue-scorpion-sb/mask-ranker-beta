<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢è†œå¤§æ¯”æ‹¼ Cloud âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .quadrant-bg { background-size: 30px 30px; background-image: radial-gradient(circle, #fbcfe8 1px, transparent 1px); }
        .mask-node { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 30; cursor: pointer; }
        .mask-node:hover { z-index: 100; transform: scale(1.1); }
        .tooltip { 
            position: absolute; bottom: 115%; width: 260px; background: rgba(15, 23, 42, 0.98); 
            backdrop-filter: blur(12px); color: white; padding: 1.5rem; border-radius: 1.5rem; 
            opacity: 0; visibility: hidden; transition: all 0.2s ease; z-index: 150; pointer-events: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
        }
        .mask-node:hover .tooltip { opacity: 1; visibility: visible; }
        .outer-label { font-size: 15px; font-weight: 900; color: #f472b6; position: absolute; white-space: nowrap; z-index: 40;}
        .axis-label { font-size: 11px; font-weight: 800; color: #94a3b8; position: absolute; text-transform: uppercase; letter-spacing: 0.1em; z-index: 50; }
        .btn-action { pointer-events: auto; transition: all 0.2s; cursor: pointer; }
    </style>
</head>
<body class="bg-pink-50/30 min-h-screen pb-20 font-sans text-slate-800">

    <div class="max-w-7xl mx-auto p-4 md:p-6 pt-10">
        <header class="flex justify-between items-center mb-12 border-b-2 border-pink-200 pb-6">
            <div class="flex items-center gap-4">
                <button onclick="toggleSettings()" class="bg-white p-3 rounded-2xl shadow-sm border border-pink-100 hover:bg-pink-50 transition-colors">âš™ï¸ é…ç½®åœ–è¡¨</button>
                <h1 class="text-3xl font-black text-pink-600 tracking-tighter italic">ğŸ’– MASK<span class="text-indigo-950">CLOUD</span></h1>
            </div>
            <div class="bg-white px-5 py-2 rounded-full border-2 border-pink-300 text-sm font-bold text-pink-500 shadow-sm flex items-center gap-2">
                ğŸ‘¤ <span id="displayUserName">è¼‰å…¥ä¸­...</span>
            </div>
        </header>

        <div id="settingsPanel" class="hidden bg-indigo-950 text-white p-8 rounded-[2.5rem] mb-12 shadow-2xl border-4 border-indigo-400">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2 border-b border-white/10 pb-4">ğŸ› ï¸ åœ–è¡¨æ¯”ä¾‹èˆ‡åˆ†ç•Œç·šè¨­å®š</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="space-y-4">
                    <p class="text-pink-400 font-black italic">ğŸ’° åƒ¹éŒ¢è»¸ (Y-Axis)</p>
                    <div>
                        <label class="block text-[10px] text-indigo-300 font-bold mb-1">åœ–è¡¨æœ€é«˜åƒ¹éŒ¢ ($)</label>
                        <input type="number" id="limitPrice" class="w-full bg-white/10 rounded-xl p-3 border border-white/20 outline-none" value="150" oninput="renderCurrentData()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-indigo-300 font-bold mb-1">ã€Œè²´ã€çš„åˆ†ç•Œç·š ($)</label>
                        <input type="number" id="splitPrice" class="w-full bg-white/10 rounded-xl p-3 border border-white/20 outline-none" value="60" oninput="renderCurrentData()">
                    </div>
                </div>
                <div class="space-y-4">
                    <p class="text-pink-400 font-black italic">â­ è©•åˆ†è»¸ (X-Axis)</p>
                    <div>
                        <label class="block text-[10px] text-indigo-300 font-bold mb-1">è©•åˆ†ä¸Šé™ (é€šå¸¸æ˜¯ 10)</label>
                        <input type="number" id="limitRating" class="w-full bg-white/10 rounded-xl p-3 border border-white/20 outline-none" value="10" oninput="renderCurrentData()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-indigo-300 font-bold mb-1">ã€Œå¥½ç”¨ã€çš„åˆ†ç•Œç·š (è©•åˆ†)</label>
                        <input type="number" id="splitRating" class="w-full bg-white/10 rounded-xl p-3 border border-white/20 outline-none" value="7.5" step="0.5" oninput="renderCurrentData()">
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
            <div class="lg:col-span-4">
                <div id="inputCard" class="bg-white p-8 rounded-[2.5rem] shadow-xl border-2 border-pink-100 sticky top-6">
                    <h2 id="formTitle" class="text-xl font-bold mb-6 text-indigo-950 italic">ğŸš€ åŠ å…¥æ–°é¢è†œ</h2>
                    <div class="space-y-4">
                        <input type="text" id="mName" class="w-full bg-slate-50 rounded-2xl p-4 border-2 border-transparent focus:border-pink-200 outline-none" placeholder="ğŸ·ï¸ é¢è†œåç¨±">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="mPrice" class="w-full bg-slate-50 rounded-2xl p-4 border-2 border-transparent focus:border-pink-200 outline-none" placeholder="ğŸ’° å–®ç‰‡åƒ¹éŒ¢">
                            <input type="number" id="mRating" min="1" max="10" step="0.1" class="w-full bg-slate-50 rounded-2xl p-4 border-2 border-transparent focus:border-pink-200 outline-none" placeholder="â­ è©•åˆ† 1-10">
                        </div>
                        <input type="text" id="mSource" class="w-full bg-slate-50 rounded-2xl p-4 border-2 border-transparent focus:border-pink-200 outline-none" placeholder="ğŸ“ è³¼å…¥åœ°é»">
                        <input type="text" id="mComment" maxlength="20" class="w-full bg-slate-50 rounded-2xl p-4 border-2 border-transparent focus:border-pink-200 outline-none" placeholder="ğŸ’¬ ç°¡çŸ­è©•èª (20å­—)">
                        <input type="file" id="mImg" accept="image/*" class="block w-full text-xs text-slate-400">
                        <div class="flex gap-2 pt-2">
                            <button onclick="saveData()" id="saveBtn" class="flex-1 bg-indigo-950 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-black transition-all">ç™¼å¸ƒ â˜ï¸</button>
                            <button onclick="cancelEdit()" id="cancelBtn" class="hidden px-6 bg-slate-100 text-slate-500 font-bold rounded-2xl">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 relative px-4">
                <div class="outer-label -top-10 left-0 text-red-500">ğŸ’¸ åˆè²´åˆå·®</div>
                <div class="outer-label -top-10 right-0 text-emerald-600">ğŸ’ è²´å©¦é¦–é¸</div>
                <div class="outer-label -bottom-10 left-0 text-slate-500">ğŸ’¤ å¹³åº¸ç²—ç”¨</div>
                <div class="outer-label -bottom-10 right-0 text-blue-600">ğŸ”¥ æ€§åƒ¹æ¯”ç‹</div>
                <div class="axis-label top-1/2 -left-20 -rotate-90 origin-center">åƒ¹éŒ¢ (é«˜ â†’ ä½)</div>
                <div class="axis-label -bottom-16 left-1/2 -translate-x-1/2">è©•åˆ† (ä½ â†’ é«˜)</div>

                <div class="relative bg-white rounded-[3.5rem] shadow-2xl border-[16px] border-white overflow-hidden aspect-square ring-4 ring-pink-100/50">
                    <div id="gridLayer" class="absolute inset-0 quadrant-bg pointer-events-none">
                        <div id="yLine" class="absolute h-full w-[2px] bg-pink-300 z-10"></div>
                        <div id="xLine" class="absolute w-full h-[2px] bg-pink-300 z-10"></div>
                    </div>
                    <div id="chartArea" class="absolute inset-0 z-30 pointer-events-none p-6"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://ayulzvrljioqcfoqrsev.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dWx6dnJsamlvcWNmb3Fyc2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzk3MzUsImV4cCI6MjA4NDk1NTczNX0.3iCIGRfR42cg12qoE5IUHb0EFn1yq9dDqAW-jcFmQDo';
        let client, myName = localStorage.getItem('mask_username'), editingId = null, cachedData = [];

        async function initApp() {
            if (!window.supabase || SB_URL.includes('YOUR_')) return;
            client = window.supabase.createClient(SB_URL, SB_KEY);
            if (!myName) {
                myName = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š") || "é¢è†œåšä¸»";
                localStorage.setItem('mask_username', myName);
            }
            document.getElementById('displayUserName').innerText = myName;
            await loadData();
            setInterval(loadData, 15000);
        }

        async function loadData() {
            const { data, error } = await client.from('masks').select('*').order('created_at', { ascending: false });
            if (!error) { cachedData = data; renderCurrentData(); }
        }

        function renderCurrentData() {
            const area = document.getElementById('chartArea');
            area.innerHTML = '';
            
            // ç²å–æ‰‹å‹•è¨­å®šçš„ä¸Šé™èˆ‡åˆ†ç•Œ
            const limitP = parseFloat(document.getElementById('limitPrice').value) || 200;
            const limitR = parseFloat(document.getElementById('limitRating').value) || 10;
            const splitP = parseFloat(document.getElementById('splitPrice').value) || 60;
            const splitR = parseFloat(document.getElementById('splitRating').value) || 7.5;

            // è¨ˆç®—åå­—æ¶ç™¾åˆ†æ¯”ä½ç½®
            const xSplitPercent = ((splitR - 1) / (limitR - 1)) * 100;
            const ySplitPercent = (1 - (splitP / limitP)) * 100;
            
            document.getElementById('yLine').style.left = `${xSplitPercent}%`;
            document.getElementById('xLine').style.top = `${ySplitPercent}%`;

            cachedData.forEach(m => {
                const x = ((m.rating - 1) / (limitR - 1)) * 100;
                const y = (1 - (m.price / limitP)) * 100;
                
                const node = document.createElement('div');
                node.className = "mask-node absolute w-16 h-16 -ml-8 -mt-8 pointer-events-auto";
                // é™åˆ¶åœ¨åœ–è¡¨å…§éƒ¨
                node.style.left = `${Math.max(2, Math.min(x, 98))}%`;
                node.style.top = `${Math.max(2, Math.min(y, 98))}%`;

                let ttStyle = x > 75 ? "right:0;left:auto;transform:translateX(0);" : (x < 25 ? "left:0;transform:translateX(0);" : "left:50%;transform:translateX(-50%);");

                node.innerHTML = `
                    <div class="w-full h-full rounded-2xl border-[3px] shadow-lg overflow-hidden bg-white ${m.user_name === myName ? 'border-pink-400 ring-4 ring-pink-50' : 'border-indigo-400'}">
                        ${m.img_url ? `<img src="${m.img_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center font-black text-xl text-slate-200 uppercase">${m.name.substring(0,1)}</div>`}
                    </div>
                    <div class="tooltip" style="${ttStyle}">
                        <div class="flex justify-between items-start mb-2">
                            <p class="font-black text-pink-400 text-lg uppercase leading-tight pr-4">${m.name}</p>
                            <div class="flex gap-2">
                                <button onclick="startEdit(${m.id}, '${m.name.replace(/'/g, "\\'")}', ${m.price}, ${m.rating}, '${m.source.replace(/'/g, "\\'")}', '${(m.comment || '').replace(/'/g, "\\'")}')" class="btn-action">âœï¸</button>
                                <button onclick="deleteItem(${m.id}, '${m.name.replace(/'/g, "\\'")}')" class="btn-action">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <p class="text-[11px] text-white/40 mb-4 italic">by ${m.user_name}</p>
                        <div class="space-y-2 text-[13px] mb-4">
                            <div class="flex justify-between border-b border-white/10 pb-1"><span>ğŸ’° åƒ¹éŒ¢</span><span class="font-bold">$${m.price}</span></div>
                            <div class="flex justify-between border-b border-white/10 pb-1"><span>â­ è©•åˆ†</span><span class="font-bold text-pink-400">${m.rating}/10</span></div>
                            <div class="flex justify-between border-b border-white/10 pb-1 text-white/70"><span>ğŸ“ è³¼å…¥åœ°é»</span><span>${m.source || '--'}</span></div>
                        </div>
                        ${m.comment ? `<div class="bg-white/10 p-3 rounded-xl border-l-4 border-pink-500 italic text-[13px] text-slate-200">"${m.comment}"</div>` : ''}
                    </div>
                `;
                area.appendChild(node);
            });
        }

        async function saveData() {
            const name = document.getElementById('mName').value;
            const price = parseFloat(document.getElementById('mPrice').value);
            const rating = parseFloat(document.getElementById('mRating').value);
            const source = document.getElementById('mSource').value;
            const comment = document.getElementById('mComment').value;
            const imgFile = document.getElementById('mImg').files[0];
            if (!name || isNaN(price) || isNaN(rating)) return alert("å¡«å¥½è³‡æ–™å…ˆï¼ğŸ’…");
            const btn = document.getElementById('saveBtn'); btn.disabled = true;
            try {
                let payload = { name, price, rating, source, comment, user_name: myName };
                if (imgFile) payload.img_url = await new Promise(r => { const f = new FileReader(); f.onload = e => r(e.target.result); f.readAsDataURL(imgFile); });
                const { error } = editingId ? await client.from('masks').update(payload).eq('id', editingId) : await client.from('masks').insert([payload]);
                if (error) throw error;
                cancelEdit(); await loadData();
            } catch (err) { alert(err.message); } finally { btn.disabled = false; }
        }

        async function deleteItem(id, name) {
            if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) { await client.from('masks').delete().eq('id', id); await loadData(); }
        }

        function startEdit(id, name, price, rating, source, comment) {
            editingId = id; document.getElementById('mName').value = name; document.getElementById('mPrice').value = price;
            document.getElementById('mRating').value = rating; document.getElementById('mSource').value = source;
            document.getElementById('mComment').value = comment || ''; document.getElementById('formTitle').innerText = "âœï¸ ç·¨è¼¯è©•æ¸¬";
            document.getElementById('saveBtn').innerText = "æ›´æ–°è³‡æ–™ ğŸ’¾"; document.getElementById('cancelBtn').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            editingId = null; ["mName", "mPrice", "mRating", "mSource", "mComment", "mImg"].forEach(id => document.getElementById(id).value = '');
            document.getElementById('formTitle').innerText = "ğŸš€ åŠ å…¥æ–°é¢è†œ"; document.getElementById('saveBtn').innerText = "ç™¼å¸ƒè©•æ¸¬ â˜ï¸";
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); }
        initApp();
    </script>
</body>
</html>
