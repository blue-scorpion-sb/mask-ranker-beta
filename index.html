<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mask Ranker âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-size: 1rem; background: #fff5f7; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        .quadrant-bg { background-size: 25px 25px; background-image: radial-gradient(circle, #fbcfe8 1.2px, transparent 1.2px); }

        /* åˆ†é¡æ¨™ç±¤ */
        .outer-label { font-size: 0.95rem; font-weight: 900; position: absolute; z-index: 40; pointer-events: none; padding: 4px 12px; border-radius: 10px; background: rgba(255,255,255,0.75); backdrop-filter: blur(4px); }
        .label-tl { top: 1.2rem; left: 1.2rem; color: #ef4444; } /* è²´ + ä½åˆ† */
        .label-tr { top: 1.2rem; right: 1.2rem; color: #10b981; } /* è²´ + é«˜åˆ† */
        .label-bl { bottom: 1.2rem; left: 1.2rem; color: #64748b; } /* å¹³ + ä½åˆ† */
        .label-br { bottom: 1.2rem; right: 1.2rem; color: #2563eb; } /* å¹³ + é«˜åˆ† */

        #pinch-viewport { position: relative; overflow: hidden; touch-action: none; border-radius: 1.5rem; background: white; border: 2px solid #fee2e2; width: 100%; }
        
        /* Desktop Tooltip */
        .tooltip { 
            position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%); 
            width: 260px; background: #1e293b; color: white; padding: 1.2rem; 
            border-radius: 1.5rem; opacity: 0; visibility: hidden; pointer-events: auto; z-index: 9999;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); transition: all 0.2s;
        }
        @media (min-width: 768px) {
            .active-node .tooltip { opacity: 1; visibility: visible; }
            .t-bottom .tooltip { bottom: auto; top: 130%; } /* å¦‚æœåœ¨é ‚éƒ¨ï¼Œå‘ä¸‹é–‹ */
            .t-left .tooltip { transform: translateX(0); left: -10px; }
            .t-right .tooltip { transform: translateX(-100%); left: calc(100% + 10px); }
        }
        @media (max-width: 767px) { .tooltip { display: none !important; } }

        /* æ‰‹æ©Ÿåº•éƒ¨æŠ½å±œ */
        #mobileDrawer {
            position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; color: white;
            padding: 2.2rem 2rem; border-top-left-radius: 2.5rem; border-top-right-radius: 2.5rem;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0, 0, 0.2, 1);
            z-index: 5000; box-shadow: 0 -15px 40px rgba(0,0,0,0.4);
        }
        #mobileDrawer.open { transform: translateY(0); }

        .mask-node { cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .active-node { z-index: 500 !important; transform: scale(1.1); }
        
        /* è»¸ç·šè£é£¾ */
        .axis-line { position: absolute; background: rgba(244, 114, 182, 0.3); pointer-events: none; }
        .arrow-up { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid rgba(244, 114, 182, 0.5); position: absolute; top: -10px; left: -5px; }
        .arrow-right { width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 10px solid rgba(244, 114, 182, 0.5); position: absolute; right: -10px; top: -5px; }
    </style>
</head>
<body onclick="closeAllTooltips()" class="p-3 md:p-8">

    <div class="fixed top-5 right-5 z-[3000]">
        <button onclick="event.stopPropagation(); toggleSettings()" class="bg-white/90 p-3.5 rounded-2xl shadow-xl border border-pink-100 text-2xl active:scale-90 transition-transform">âš™ï¸</button>
    </div>

    <div id="settingsPanel" class="hidden bg-slate-900 text-white p-7 rounded-[2rem] fixed right-5 top-20 z-[3001] w-72 shadow-2xl" onclick="event.stopPropagation()">
        <h3 class="text-pink-400 font-black mb-5 text-sm uppercase">åœ–è¡¨ç¯„åœè¨­å®š</h3>
        <div class="space-y-5 text-xs text-black">
            <div class="bg-white/5 p-4 rounded-2xl">
                <p class="mb-2 text-white opacity-60 font-bold uppercase">ğŸ’° åƒ¹éŒ¢ (MAX / åˆ†ç•Œ)</p>
                <div class="flex gap-2">
                    <input type="number" id="limitPrice" class="w-1/2 rounded-xl p-2 outline-none" value="12" oninput="renderCurrentData()">
                    <input type="number" id="splitPrice" class="w-1/2 rounded-xl p-2 outline-none" value="6" oninput="renderCurrentData()">
                </div>
            </div>
            <div class="bg-white/5 p-4 rounded-2xl">
                <p class="mb-2 text-white opacity-60 font-bold uppercase">â­ è©•åˆ† (MAX / åˆ†ç•Œ)</p>
                <div class="flex gap-2">
                    <input type="number" id="limitRating" class="w-1/2 rounded-xl p-2 outline-none" value="10" oninput="renderCurrentData()">
                    <input type="number" id="splitRating" class="w-1/2 rounded-xl p-2 outline-none" value="5.5" oninput="renderCurrentData()">
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-black text-pink-600 italic">Mask Ranker</h1>
            <p id="displayUserName" class="text-[10px] font-bold text-pink-400 uppercase tracking-widest mt-1">ğŸ‘¤ LOADING...</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="w-full lg:w-[350px] shrink-0 order-2 lg:order-1" onclick="event.stopPropagation()">
                <div class="bg-white p-7 rounded-[2.5rem] shadow-xl border border-pink-50 sticky top-8">
                    <h2 id="formTitle" class="text-xl font-black mb-6">ğŸš€ è©•æ¸¬é¢è†œ</h2>
                    <div class="space-y-4">
                        <input type="text" id="mName" class="w-full bg-slate-50 rounded-2xl p-4 outline-none border-2 border-transparent focus:border-pink-200" placeholder="ğŸ·ï¸ é¢è†œå…¨å">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="mPrice" class="w-full bg-slate-50 rounded-2xl p-4 outline-none" placeholder="ğŸ’° å–®ç‰‡åƒ¹éŒ¢">
                            <input type="number" id="mRating" class="w-full bg-slate-50 rounded-2xl p-4 outline-none" placeholder="â­ è©•åˆ† 1-10">
                        </div>
                        <input type="text" id="mSource" class="w-full bg-slate-50 rounded-2xl p-4 outline-none" placeholder="ğŸ“ è³¼è²·åœ°é»">
                        <textarea id="mComment" maxlength="20" rows="1" class="w-full bg-slate-50 rounded-2xl p-4 outline-none resize-none" placeholder="ğŸ’¬ çŸ­è©• (20å­—)"></textarea>
                        
                        <label for="mImg" class="flex flex-col items-center justify-center w-full h-28 border-2 border-dashed border-pink-100 rounded-2xl cursor-pointer bg-pink-50/50 overflow-hidden relative">
                            <img id="imgPreview" class="absolute inset-0 w-full h-full object-cover hidden">
                            <div id="uploadPrompt" class="text-center text-pink-400"><span class="text-3xl">ğŸ“¸</span><p class="text-[10px] font-bold mt-1 uppercase">ä¸Šå‚³åœ–ç‰‡</p></div>
                            <input type="file" id="mImg" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
                        </label>
                        <button onclick="saveData()" id="saveBtn" class="w-full bg-pink-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all text-lg">ç™¼å¸ƒè©•æ¸¬</button>
                    </div>
                </div>
            </div>

            <div class="flex-1 w-full order-1 lg:order-2">
                <div id="pinch-viewport" class="aspect-square shadow-2xl">
                    <div id="canvas-area" class="quadrant-bg w-full h-full relative">
                        <div class="outer-label label-tl">ğŸ’¸ æµªè²»é‡‘éŒ¢</div>
                        <div class="outer-label label-tr">ğŸ’ è²´å©¦é¦–é¸</div>
                        <div class="outer-label label-bl">ğŸ’¤ å¹³åƒ¹ç²—ç”¨</div>
                        <div class="outer-label label-br">ğŸ”¥ å¿…é ˆå›è³¼</div>

                        <div id="yLine" class="axis-line h-[calc(100%-40px)] w-[2.5px] top-[20px]"><div class="arrow-up"></div></div>
                        <div id="xLine" class="axis-line w-[calc(100%-40px)] h-[2.5px] left-[20px]"><div class="arrow-right"></div></div>
                        
                        <div id="chartArea" class="absolute inset-0 p-8"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mobileDrawer">
        <div class="w-16 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <div id="drawerContent"></div>
    </div>

    <script>
        const SB_URL = 'https://ayulzvrljioqcfoqrsev.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dWx6dnJsamlvcWNmb3Fyc2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzk3MzUsImV4cCI6MjA4NDk1NTczNX0.3iCIGRfR42cg12qoE5IUHb0EFn1yq9dDqAW-jcFmQDo';
        const client = supabase.createClient(SB_URL, SB_KEY);

        let myName = localStorage.getItem('mask_username'), cachedData = [], editingId = null;

        // Pinch Zoom
        const viewport = document.getElementById('pinch-viewport');
        const canvas = document.getElementById('canvas-area');
        let scale = 1, startDist = 0, startScale = 1;

        viewport.addEventListener('touchstart', e => { if (e.touches.length === 2) { startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); startScale = scale; } });
        viewport.addEventListener('touchmove', e => { if (e.touches.length === 2) { e.preventDefault(); const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); scale = Math.min(Math.max(1, startScale * (dist / startDist)), 4); canvas.style.transform = `scale(${scale})`; } }, {passive: false});

        async function initApp() {
            if (!myName) { myName = prompt("è«‹è¼¸å…¥åå­—ï¼š") || "åŒ¿å"; localStorage.setItem('mask_username', myName); }
            document.getElementById('displayUserName').innerText = "ğŸ‘¤ " + myName;
            await loadData(); setInterval(loadData, 20000);
        }

        async function loadData() {
            const { data, error } = await client.from('masks').select('*').order('created_at', { ascending: false });
            if (!error) { cachedData = data; renderCurrentData(); }
        }

        function renderCurrentData() {
            const area = document.getElementById('chartArea'); area.innerHTML = '';
            const limitP = parseFloat(document.getElementById('limitPrice').value) || 12;
            const limitR = parseFloat(document.getElementById('limitRating').value) || 10;
            const splitP = parseFloat(document.getElementById('splitPrice').value) || 6;
            const splitR = parseFloat(document.getElementById('splitRating').value) || 5.5;

            const pad = 20;
            const w = viewport.clientWidth - (pad * 2);
            const h = viewport.clientHeight - (pad * 2);

            // åˆ†ç•Œç·šä½ç½® (Yè»¸åŒæ¨£éœ€è¦åè½‰è¨ˆç®—)
            document.getElementById('yLine').style.left = `calc(${pad}px + ${((splitR - 1) / (limitR - 1)) * w}px)`;
            document.getElementById('xLine').style.top = `calc(${pad}px + ${(1 - (splitP / limitP)) * h}px)`;

            cachedData.forEach(m => {
                const xPct = ((m.rating - 1) / (limitR - 1));
                const yPct = (m.price / limitP);
                
                const node = document.createElement('div');
                
                // ğŸ’¡ ä¿®æ­£è™•ï¼šy è»¸æ”¹ç‚º (1 - yPct)ï¼Œä»¤å¤§æ•¸æ“šåœ¨ä¸Šæ–¹
                let topPos = 10 + ((1 - yPct) * 80);
                let leftPos = 10 + (xPct * 80);

                // Tooltip æ–¹å‘åˆ¤å®š
                let sideClass = xPct > 0.6 ? "t-right" : (xPct < 0.4 ? "t-left" : "");
                let topClass = (1 - yPct) < 0.4 ? "t-bottom" : ""; // å–ºé ‚éƒ¨æ™‚å‘ä¸‹é–‹
                
                node.className = `mask-node absolute w-11 h-11 -ml-5.5 -mt-5.5 ${sideClass} ${topClass}`;
                node.style.left = `${leftPos}%`;
                node.style.top = `${topPos}%`;
                
                node.onclick = (e) => {
                    e.stopPropagation();
                    closeAllTooltips();
                    node.classList.add('active-node');
                    if (window.innerWidth < 768) showDrawer(m);
                };

                node.innerHTML = `
                    <div class="w-full h-full rounded-2xl border-[3px] shadow-lg overflow-hidden bg-white ${m.user_name === myName ? 'border-pink-500' : 'border-slate-100'}">
                        ${m.img_url ? `<img src="${m.img_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center font-black text-slate-200 text-xs">${m.name[0]}</div>`}
                    </div>
                    <div class="tooltip" onclick="event.stopPropagation()">
                        <div class="absolute top-4 right-4 flex gap-3 text-lg">
                            <button onclick="startEdit(${m.id}, '${m.name}', ${m.price}, ${m.rating}, '${m.source}', '${m.comment}')">âœï¸</button>
                            <button onclick="deleteItem(${m.id})" class="text-red-400">ğŸ—‘ï¸</button>
                        </div>
                        <h3 class="font-black text-pink-400 text-lg leading-tight break-words pr-12">${m.name}</h3>
                        <p class="text-[9px] font-bold opacity-40 mt-1 uppercase">Uploaded by ${m.user_name}</p>
                        <div class="grid grid-cols-2 gap-4 my-4 py-3 border-y border-white/10 font-bold text-sm">
                            <div><span class="block text-[8px] opacity-30">PRICE</span>$${m.price}</div>
                            <div><span class="block text-[8px] opacity-30">RATING</span>${m.rating}/10</div>
                        </div>
                        <p class="text-[10px] opacity-30 font-bold mb-1 uppercase tracking-tighter">Location</p>
                        <p class="text-xs mb-3 font-semibold">${m.source || 'æœªçŸ¥'}</p>
                        <div class="bg-white/5 p-3 rounded-xl italic text-xs leading-relaxed">"${m.comment || '-'}"</div>
                    </div>
                `;
                area.appendChild(node);
            });
        }

        function showDrawer(m) {
            const drawer = document.getElementById('mobileDrawer');
            document.getElementById('drawerContent').innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <h3 class="text-2xl font-black text-pink-400 leading-tight pr-4">${m.name}</h3>
                    <div class="flex gap-6 text-2xl">
                        <button onclick="startEdit(${m.id}, '${m.name}', ${m.price}, ${m.rating}, '${m.source}', '${m.comment}')">âœï¸</button>
                        <button onclick="deleteItem(${m.id})" class="text-red-400">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <p class="text-xs font-bold opacity-40 uppercase tracking-[0.2em] -mt-4 mb-8">User: ${m.user_name}</p>
                <div class="grid grid-cols-2 gap-5 mb-5">
                    <div class="bg-white/5 p-5 rounded-3xl font-bold"><p class="text-[10px] opacity-30 mb-1">PRICE</p><p class="text-2xl italic">$${m.price}</p></div>
                    <div class="bg-white/5 p-5 rounded-3xl font-bold"><p class="text-[10px] opacity-30 mb-1">RATING</p><p class="text-2xl italic">${m.rating}/10</p></div>
                </div>
                <div class="bg-white/5 p-5 rounded-3xl mb-5 font-bold"><p class="text-[10px] opacity-30 mb-1">LOCATION</p><p class="text-sm">${m.source || '-'}</p></div>
                <div class="bg-pink-600/10 p-6 rounded-3xl border border-pink-500/20"><p class="italic text-base leading-relaxed">"${m.comment || 'å†‡è©•èª'}"</p></div>
            `;
            drawer.classList.add('open');
        }

        function closeAllTooltips() { document.querySelectorAll('.mask-node').forEach(n => n.classList.remove('active-node')); document.getElementById('mobileDrawer').classList.remove('open'); }
        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); }
        function handleImageSelect(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = e => { document.getElementById('imgPreview').src = e.target.result; document.getElementById('imgPreview').classList.remove('hidden'); document.getElementById('uploadPrompt').classList.add('hidden'); }; r.readAsDataURL(input.files[0]); } }
        
        async function saveData() {
            const name = document.getElementById('mName').value;
            const price = parseFloat(document.getElementById('mPrice').value);
            const rating = parseFloat(document.getElementById('mRating').value);
            if (!name || isNaN(price)) return alert("è«‹å¡«å¯«å¿…è¦è³‡æ–™");
            const btn = document.getElementById('saveBtn'); btn.innerText = "å„²å­˜ä¸­...";
            try {
                let imgUrl = "";
                const imgFile = document.getElementById('mImg').files[0];
                if (imgFile) {
                    const fileName = `${Date.now()}.jpg`;
                    await client.storage.from('mask-images').upload(fileName, imgFile);
                    imgUrl = client.storage.from('mask-images').getPublicUrl(fileName).data.publicUrl;
                }
                const payload = { name, price, rating, source: document.getElementById('mSource').value, comment: document.getElementById('mComment').value, user_name: myName };
                if (imgUrl) payload.img_url = imgUrl;
                if (editingId) await client.from('masks').update(payload).eq('id', editingId);
                else await client.from('masks').insert([payload]);
                location.reload();
            } catch (e) { alert(e.message); btn.innerText = "ç™¼å¸ƒ"; }
        }

        function startEdit(id, n, p, r, s, c) { 
            editingId = id; document.getElementById('mName').value = n; document.getElementById('mPrice').value = p; 
            document.getElementById('mRating').value = r; document.getElementById('mSource').value = s; 
            document.getElementById('mComment').value = c; document.getElementById('formTitle').innerText = "âœï¸ ç·¨è¼¯ä¸­"; 
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); 
            closeAllTooltips(); 
        }

        async function deleteItem(id) { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await client.from('masks').delete().eq('id', id); location.reload(); } }
        initApp();
    </script>
</body>
</html>
