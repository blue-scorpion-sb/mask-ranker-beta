<!DOCTYPE html> 

<html lang="zh-HK"> 

<head> 

    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Mask Ranker beta âœ¨</title> 
    <script src="https://cdn.tailwindcss.com"></script> 
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script> 
	
    <style> 

        body { font-size: 1rem; overflow-x: hidden; touch-action: pan-y; }  
        .quadrant-bg { background-size: 25px 25px; background-image: radial-gradient(circle, #fbcfe8 1.5px, transparent 1.5px); }          

        /* å››è§’è±¡é™æ¨™ç±¤ - èª¿å¤§å­—é«”ä¸¦è²¼è¿‘æ¡† */ 
        .outer-label { font-size: 1.1rem; font-weight: 900; position: absolute; white-space: nowrap; z-index: 40; pointer-events: none; text-shadow: 0 0 10px white; }          

        /* åæ¨™è»¸æ¨™é¡Œ */ 
        .axis-title { font-size: 0.8rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.15em; position: absolute; white-space: nowrap; z-index: 5; } 
        .y-axis-label { left: -35px; top: 50%; transform: translateY(-50%) rotate(-90deg); transform-origin: center; } 
        .x-axis-label { bottom: -25px; left: 50%; transform: translateX(-50%); } 
 
        /* éš±è— Scrollbar */ 
        #pinch-viewport { overflow: auto; scrollbar-width: none; -ms-overflow-style: none; -webkit-overflow-scrolling: touch; } 
        #pinch-viewport::-webkit-scrollbar { display: none; }  

        /* åå­—ç·šç®­é ­ */ 
        #yLine::after { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); border-left: 7px solid transparent; border-right: 7px solid transparent; border-bottom: 14px solid rgba(244, 114, 182, 0.8); } 
        #xLine::after { content: ''; position: absolute; right: -12px; top: 50%; transform: translateY(-50%); border-top: 7px solid transparent; border-bottom: 7px solid transparent; border-left: 14px solid rgba(244, 114, 182, 0.8); } 

        /* --- çµ±ä¸€ Tooltip æ¨£å¼ --- */ 
		.tooltip {  
			position: absolute;  
			bottom: 130%;  
			left: 50%;  
			transform: translateX(-50%);  
			width: 260px; /* ç¨å¾®ç¸®çª„å°‘å°‘ï¼Œå¢åŠ æ‰‹æ©Ÿç‰ˆå®¹éŒ¯ç‡ */ 
			background: rgba(15, 23, 42, 0.98);  
			color: white;  
			padding: 1.2rem;  
			border-radius: 1.5rem;  
			opacity: 0; 
			visibility: hidden;  
			pointer-events: auto;  
			box-shadow: 0 20px 40px rgba(0,0,0,0.5);  
			z-index: 9999; 
			transition: opacity 0.2s, visibility 0.2s; 
		}  
		/* é è¿‘å³é‚Šï¼šå‘å·¦ç¸® */ 
		.tooltip-right-align { 
			left: auto !important; 
			right: 0 !important; 
			transform: translateX(10%) !important; 
		} 	 
		/* é è¿‘å·¦é‚Šï¼šå‘å³ç¸® */ 
		.tooltip-left-align { 
			left: 0 !important; 
			transform: translateX(-10%) !important; 
		} 		 
		/* é è¿‘é ‚éƒ¨ï¼šå‘ä¸‹é–‹ */ 
		.tooltip-down { 
			bottom: auto !important; 
			top: 130% !important; 
		} 		 
		/* æ‰‹æ©Ÿç‰ˆå¾®èª¿ï¼šç•¶ active æ™‚é¡¯ç¤º */ 
		.active-node .tooltip {  
			opacity: 1 !important;  
			visibility: visible !important;  
		} 
		

        .mask-node { transition: transform 0.2s; z-index: 100; cursor: pointer; } 
        .active-node { z-index: 150 !important; } 
        .tooltip { position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%); width: 280px; background: rgba(15, 23, 42, 0.98); color: white; padding: 1.2rem; border-radius: 1.5rem; opacity: 0; visibility: hidden; pointer-events: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.4); } 
        .active-node .tooltip { opacity: 1; visibility: visible; }          

        /* Placeholder å­—é«”èª¿ç´° */ 
        input::placeholder, textarea::placeholder { font-size: 0.85rem !important; color: #cbd5e1; } 
		
    </style> 

</head> 

<body class="bg-pink-50/20 min-h-screen pb-10" onclick="closeAllTooltips()"> 
 
    <div class="max-w-7xl mx-auto p-4 pt-6"> 
        <header class="flex justify-between items-center mb-6 border-b border-pink-100 pb-4"> 
            <div class="flex items-center gap-3"> 
                <button onclick="event.stopPropagation(); toggleSettings()" class="bg-white p-2 rounded-lg shadow-sm text-xl border">âš™ï¸</button> 
                <h1 class="text-2xl font-black text-pink-600 tracking-tight italic">Mask Ranker</h1> 
            </div> 
            <div id="displayUserName" class="text-[10px] bg-white px-3 py-1 rounded-full border border-pink-200 font-bold text-pink-500 uppercase tracking-widest">ğŸ‘¤ LOADING...</div> 
        </header>  

        <div id="settingsPanel" class="hidden bg-slate-900 text-white p-6 rounded-3xl mb-6 shadow-xl" onclick="event.stopPropagation()"> 
            <div class="grid grid-cols-2 gap-4 text-xs font-bold uppercase tracking-widest"> 
                <div class="space-y-2"> 
                    <p class="text-pink-400">ğŸ’° Price Max / Split</p> 
                    <input type="number" id="limitPrice" class="w-full bg-white/10 rounded-lg p-2" value="12" oninput="renderCurrentData()"> 
                    <input type="number" id="splitPrice" class="w-full bg-white/10 rounded-lg p-2" value="6" oninput="renderCurrentData()"> 
                </div> 
                <div class="space-y-2"> 
                    <p class="text-pink-400">â­ Rating Max / Split</p> 
                    <input type="number" id="limitRating" class="w-full bg-white/10 rounded-lg p-2" value="10" oninput="renderCurrentData()"> 
                    <input type="number" id="splitRating" class="w-full bg-white/10 rounded-lg p-2" value="5.5" oninput="renderCurrentData()"> 
                </div> 
            </div> 
        </div>  

        <div class="flex flex-col xl:flex-row gap-6"> 
            <div class="xl:w-[350px] order-2 xl:order-1" onclick="event.stopPropagation()"> 
                <div id="inputCard" class="bg-white p-6 rounded-[2rem] shadow-lg border border-pink-100"> 
                    <h2 id="formTitle" class="text-xl font-black mb-4 text-slate-800 italic">ğŸš€ è©•æ¸¬é¢è†œ</h2> 
                    <div class="space-y-3"> 
                        <input type="text" id="mName" class="w-full bg-slate-50 rounded-xl p-3 outline-none" placeholder="ğŸ·ï¸ é¢è†œå…¨å"> 
                        <div class="grid grid-cols-2 gap-2"> 
                            <input type="number" id="mPrice" class="w-full bg-slate-50 rounded-xl p-3 outline-none" placeholder="ğŸ’° å–®ç‰‡åƒ¹éŒ¢"> 
                            <input type="number" id="mRating" class="w-full bg-slate-50 rounded-xl p-3 outline-none" placeholder="â­ è©•åˆ† 1-10"> 
                        </div> 
                        <input type="text" id="mSource" class="w-full bg-slate-50 rounded-xl p-3 outline-none" placeholder="ğŸ“ è³¼å…¥åœ°é» (ä¾‹å¦‚: è¬å¯§)"> 
                        <textarea id="mComment" maxlength="20" rows="1" class="w-full bg-slate-50 rounded-xl p-3 outline-none" placeholder="ğŸ’¬ ç°¡çŸ­è©•èª (20å­—ä»¥å…§)"></textarea>                          

                        <div class="relative group"> 
                            <label for="mImg" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-pink-200 rounded-xl cursor-pointer bg-pink-50/30 hover:bg-pink-50 transition-all overflow-hidden relative"> 
                                <img id="imgPreview" class="absolute inset-0 w-full h-full object-cover hidden"> 
                                <div id="uploadPrompt" class="text-center"> 
                                    <span class="text-2xl">ğŸ“¸</span> 
                                    <p class="text-[10px] text-pink-500 font-bold uppercase mt-1">ä¸Šå‚³ç›¸ç‰‡</p> 
                                </div> 
                                <input type="file" id="mImg" accept="image/*" class="hidden" onchange="handleImageSelect(this)"> 
                            </label> 
                            <button id="clearImgBtn" onclick="clearImageSelection()" class="hidden absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-[10px] font-bold shadow-lg">X</button> 
                        </div>  

                        <div class="flex gap-2 pt-2"> 
                            <button onclick="saveData()" id="saveBtn" class="flex-1 bg-pink-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-all">ç™¼å¸ƒè©•æ¸¬</button> 
                            <button onclick="cancelEdit()" id="cancelBtn" class="hidden px-4 bg-slate-100 rounded-xl text-slate-400 font-bold">X</button> 
                        </div> 

                    </div> 
                </div> 
            </div>  

            <div class="xl:flex-1 order-1 xl:order-2"> 
                <div class="relative px-6 py-10 md:px-12 md:py-12"> 
                    <div class="outer-label -top-2 left-6 md:left-12 text-red-500">ğŸ’¸ æµªè²»é‡‘éŒ¢</div> 
                    <div class="outer-label -top-2 right-6 md:right-12 text-emerald-600">ğŸ’ è²´å©¦é¦–é¸</div> 
                    <div class="outer-label -bottom-2 left-6 md:left-12 text-slate-400">ğŸ’¤ å¹³åƒ¹ç²—ç”¨</div> 
                    <div class="outer-label -bottom-2 right-6 md:right-12 text-blue-600">ğŸ”¥ å¿…é ˆå›è³¼</div>  

                    <div class="axis-title y-axis-label">ğŸ’° PRICE / åƒ¹éŒ¢</div>                      

                    <div id="pinch-viewport" class="relative w-full aspect-square bg-white rounded-[2.5rem] md:rounded-[3.5rem] shadow-2xl border-4 md:border-8 border-white ring-4 ring-pink-100/30 touch-none"> 
                        <div id="canvas-area" class="relative w-full h-full origin-top-left"> 
                            <div id="gridLayer" class="absolute inset-0 quadrant-bg overflow-visible"> 
                                <div id="yLine" class="absolute h-full w-[2px] bg-pink-400/30"></div> 
                                <div id="xLine" class="absolute w-full h-[2px] bg-pink-400/30"></div> 
                            </div> 
                            <div id="chartArea" class="absolute inset-0 z-10 p-4 md:p-8"></div> 
                        </div> 
                    </div>  

                    <div class="axis-title x-axis-label w-full text-center">â­ RATING / è©•åˆ†</div> 
                </div> 
            </div> 

        </div> 

    </div> 

 

    <script> 

        const SB_URL = 'https://ayulzvrljioqcfoqrsev.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dWx6dnJsamlvcWNmb3Fyc2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzk3MzUsImV4cCI6MjA4NDk1NTczNX0.3iCIGRfR42cg12qoE5IUHb0EFn1yq9dDqAW-jcFmQDo '; 

        let client, myName = localStorage.getItem('mask_username'), cachedData = [], editingId = null;  

        // --- Pinch Zoom é‚è¼¯ --- 
        const viewport = document.getElementById('pinch-viewport'); 
        const canvas = document.getElementById('canvas-area'); 
        let currentScale = 1; 
        let initialDist = 0;  

        viewport.addEventListener('touchstart', e => { 
            if (e.touches.length === 2) { 
                initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); 
            } 
        }, {passive: false});  

        viewport.addEventListener('touchmove', e => { 
            if (e.touches.length === 2) { 
                e.preventDefault(); 
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); 
                const zoom = dist / initialDist; 
                let newScale = Math.min(Math.max(1, currentScale * zoom), 4);                  

                canvas.style.width = (newScale * 100) + '%'; 
                canvas.style.height = (newScale * 100) + '%';                  

                // é‡æ–°æ¸²æŸ“åå­—ç·š (å› ç‚ºå¯¬åº¦è®Šå’—) 
                renderGrid(); 
            } 
        }, {passive: false});  

        viewport.addEventListener('touchend', e => { 
            currentScale = parseFloat(canvas.style.width) / 100 || 1; 
        });  

        // --- æ ¸å¿ƒåŠŸèƒ½ --- 
        async function initApp() { 
            if (SB_URL.includes('YOUR_')) return; 
            client = window.supabase.createClient(SB_URL, SB_KEY); 
            if (!myName) { 
                myName = prompt("è«‹è¼¸å…¥åå­—ï¼š") || "åŒ¿å"; 
                localStorage.setItem('mask_username', myName); 
            } 
            document.getElementById('displayUserName').innerText = "ğŸ‘¤ " + myName; 
            await loadData(); 
            setInterval(loadData, 15000); 
        }  

        async function loadData() { 
            const { data, error } = await client.from('masks').select('*').order('created_at', { ascending: false }); 
            if (!error) { cachedData = data; renderCurrentData(); } 
        }  

        function renderGrid() { 
            const limitP = parseFloat(document.getElementById('limitPrice').value) || 12; 
            const limitR = parseFloat(document.getElementById('limitRating').value) || 10; 
            const splitP = parseFloat(document.getElementById('splitPrice').value) || 5.5; 
            const splitR = parseFloat(document.getElementById('splitRating').value) || 5; 
 
            const xPct = ((splitR - 1) / (limitR - 1)) * 100; 
            const yPct = (1 - (splitP / limitP)) * 100;  

            document.getElementById('yLine').style.left = `${xPct}%`; 
            document.getElementById('xLine').style.top = `${yPct}%`; 
        }  

        function renderCurrentData() { 
            const area = document.getElementById('chartArea'); 
            area.innerHTML = ''; 
            renderGrid();  

            const limitP = parseFloat(document.getElementById('limitPrice').value) || 16; 
            const limitR = parseFloat(document.getElementById('limitRating').value) || 10;  

            cachedData.forEach(m => { 
				const x = ((m.rating - 1) / (limitR - 1)) * 100; 
				const y = (1 - (m.price / limitP)) * 100; 				 

				const node = document.createElement('div'); 
				node.className = "mask-node absolute w-12 h-12 md:w-16 md:h-16 -ml-6 -mt-6 md:-ml-8 md:-mt-8"; 
				node.style.left = `${Math.max(5, Math.min(x, 95))}%`; 
				node.style.top = `${Math.max(5, Math.min(y, 95))}%`; 				 

				// --- æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·ä½ç½®ä¸¦åŠ ä¸Šå°é½Š Class --- 
				let alignClass = ""; 
				if (x > 70) alignClass = "tooltip-right-align"; // é è¿‘å³é‚Šç•Œ 
				else if (x < 30) alignClass = "tooltip-left-align"; // é è¿‘å·¦é‚Šç•Œ 				 

				let dirClass = ""; 
				if (y < 25) dirClass = "tooltip-down"; // é è¿‘é ‚éƒ¨ 			 

				node.onclick = (e) => {  
					e.stopPropagation();  
					const alreadyActive = node.classList.contains('active-node'); 
					closeAllTooltips();  
					if (!alreadyActive) node.classList.add('active-node');  
				}; 			 

				node.innerHTML = ` 
					<div class="w-full h-full rounded-2xl border-4 shadow-lg overflow-hidden bg-white ${m.user_name === myName ? 'border-pink-500' : 'border-indigo-400'}"> 
						${m.img_url ? `<img src="${m.img_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center font-black text-slate-200">${m.name[0]}</div>`} 
					</div> 
					<div class="tooltip ${alignClass} ${dirClass}" onclick="event.stopPropagation()"> 
						<div class="flex justify-between items-start mb-2"> 
							<div class="flex-1"> 
								<p class="font-black text-pink-500 leading-tight text-lg">${m.name}</p> 
								<p class="text-[9px] text-slate-400 mt-1 uppercase font-bold tracking-wider">ğŸ‘¤ Contributor: ${m.user_name || 'åŒ¿å'}</p> 
							</div> 
							<div class="flex gap-4 ml-2 shrink-0"> 
								<button onclick="startEdit(${m.id}, '${m.name.replace(/'/g, "\\'")}', ${m.price}, ${m.rating}, '${(m.source || '').replace(/'/g, "\\'")}', '${(m.comment || '').replace(/'/g, "\\'")}')" class="text-xl">âœï¸</button> 
								<button onclick="deleteItem(${m.id})" class="text-xl">ğŸ—‘ï¸</button> 
							</div> 
						</div> 						 

						<div class="grid grid-cols-3 gap-1 my-3 py-2 border-y border-white/10 text-center"> 
							<div><p class="text-[8px] opacity-50 uppercase">Price</p><p class="text-xs font-bold">$${m.price}</p></div> 
							<div><p class="text-[8px] opacity-50 uppercase">Rating</p><p class="text-xs font-bold">${m.rating}/10</p></div> 
							<div class="truncate px-1"><p class="text-[8px] opacity-50 uppercase">Shop</p><p class="text-xs font-bold truncate">${m.source || '-'}</p></div> 
						</div> 			 

						<p class="text-xs italic bg-white/5 p-3 rounded-xl border border-white/5">"${m.comment || 'å†‡è©•èª'}"</p> 
					</div> 
				`; 
				area.appendChild(node); 
			}); 
        } 

 
        // --- åœ–ç‰‡è™•ç† --- 
        function handleImageSelect(input) { 
            if (input.files && input.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = e => { 
                    document.getElementById('imgPreview').src = e.target.result; 
                    document.getElementById('imgPreview').classList.remove('hidden'); 
                    document.getElementById('uploadPrompt').classList.add('hidden'); 
                    document.getElementById('clearImgBtn').classList.remove('hidden'); 
                } 
                reader.readAsDataURL(input.files[0]); 
            } 
        }  

        function clearImageSelection() { 
            document.getElementById('mImg').value = ""; 
            document.getElementById('imgPreview').classList.add('hidden'); 
            document.getElementById('uploadPrompt').classList.remove('hidden'); 
            document.getElementById('clearImgBtn').classList.add('hidden'); 
        }  

        async function saveData() { 
            const name = document.getElementById('mName').value; 
            const price = parseFloat(document.getElementById('mPrice').value); 
            const rating = parseFloat(document.getElementById('mRating').value); 
            const source = document.getElementById('mSource').value; 
            const comment = document.getElementById('mComment').value; 
            const imgFile = document.getElementById('mImg').files[0];  

            if (!name || isNaN(price)) return alert("å¡«å¯«å¿…å¡«é …ï¼"); 
            const btn = document.getElementById('saveBtn'); btn.innerText = "è™•ç†ä¸­...";  

            try { 
                let imgUrl = ""; 
                if (imgFile) { 
                    const blob = await compressImg(imgFile); 
                    const fileName = `${Date.now()}.jpg`; 
                    await client.storage.from('mask-images').upload(fileName, blob); 
                    imgUrl = client.storage.from('mask-images').getPublicUrl(fileName).data.publicUrl; 
                }  

                const payload = { name, price, rating, source, comment, user_name: myName }; 
                if (imgUrl) payload.img_url = imgUrl; 
                if (editingId) await client.from('masks').update(payload).eq('id', editingId); 
                else await client.from('masks').insert([payload]);  

                cancelEdit(); loadData(); 
            } catch (e) { alert(e.message); } finally { btn.innerText = "ç™¼å¸ƒè©•æ¸¬"; } 
        } 

 

        function compressImg(file) { 
            return new Promise(res => { 
                const img = new Image(); img.src = URL.createObjectURL(file); 
                img.onload = () => { 
                    const canvas = document.createElement('canvas'); 
                    const m = 800; let w = img.width, h = img.height; 
                    if (w > m) { h *= m/w; w = m; } 
                    canvas.width = w; canvas.height = h; 
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h); 
                    canvas.toBlob(b => res(b), 'image/jpeg', 0.7); 
                } 
            }); 
        }  

        async function deleteItem(id) { 
            if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await client.from('masks').delete().eq('id', id); loadData(); } 
        }  

        function startEdit(id, n, p, r, s, c) { 
            editingId = id; 
            document.getElementById('mName').value = n; document.getElementById('mPrice').value = p; 
            document.getElementById('mRating').value = r; document.getElementById('mSource').value = s; 
            document.getElementById('mComment').value = c; 
            document.getElementById('formTitle').innerText = "âœï¸ ç·¨è¼¯è©•æ¸¬"; 
            document.getElementById('cancelBtn').classList.remove('hidden'); 
        } 

        function cancelEdit() { 
            editingId = null; 
            ["mName", "mPrice", "mRating", "mSource", "mComment", "mImg"].forEach(id => document.getElementById(id).value = ''); 
            clearImageSelection(); 
            document.getElementById('formTitle').innerText = "ğŸš€ è©•æ¸¬é¢è†œ"; 
            document.getElementById('cancelBtn').classList.add('hidden'); 
        }  

        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); } 
        function closeAllTooltips() { document.querySelectorAll('.mask-node').forEach(n => n.classList.remove('active-node')); } 
         

        initApp(); 

    </script> 

</body> 

</html> 
